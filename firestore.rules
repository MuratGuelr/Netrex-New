rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper fonksiyonlar
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && request.auth.token.email == 'sigortataciri@gmail.com';
    }
    
    // USERS Collection
    match /users/{userId} {
      // Kullanıcılar listesini herkes okuyabilir (authenticated)
      allow read: if isAuthenticated();
      
      // Kullanıcı sadece kendi bilgilerini yazabilir/güncelleyebilir
      allow create: if isOwner(userId) && 
                       request.resource.data.uid == userId &&
                       request.resource.data.email == request.auth.token.email;
      
      allow update: if isOwner(userId);
      
      allow delete: if isAdmin() || isOwner(userId);
      
      // Presence subcollection (online durumu)
      match /presence/{presenceId} {
        allow read, write: if isOwner(userId);
      }
      
      // Favorites subcollection (favori GIF'ler)
      match /favorites/{favoriteId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // CHANNELS Collection
    match /channels/{channelId} {
      // Kanal okuma: Authenticated kullanıcılar
      // DM kontrolü client-side'da yapılıyor, burada sadece authenticated kontrolü
      allow read: if isAuthenticated();
      
      // Kanal oluşturma: Authenticated kullanıcılar
      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.token.email &&
                       request.resource.data.createdAt is timestamp;
      
      // Kanal güncelleme: Admin veya oluşturan
      allow update: if isAuthenticated() && 
                       (isAdmin() || 
                        resource.data.createdBy == request.auth.token.email);
      
      // Kanal silme: Admin veya oluşturan (genel kanal hariç)
      allow delete: if isAuthenticated() && 
                       channelId != 'genel' &&
                       (isAdmin() || 
                        resource.data.createdBy == request.auth.token.email);
      
      // MESSAGES Subcollection
      match /messages/{messageId} {
        // Mesaj okuma: Authenticated kullanıcılar
        // DM kontrolü client-side'da yapılıyor
        allow read: if isAuthenticated();
        
        // Mesaj gönderme: Authenticated kullanıcılar
        allow create: if isAuthenticated() &&
                         request.resource.data.uid == request.auth.uid &&
                         request.resource.data.displayName is string &&
                         request.resource.data.timestamp is timestamp;
        
        // Mesaj güncelleme: Mesaj sahibi veya admin
        allow update: if isAuthenticated() && 
                         (resource.data.uid == request.auth.uid || 
                          isAdmin()) &&
                         request.resource.data.uid == resource.data.uid;
        
        // Mesaj silme: Mesaj sahibi veya admin
        allow delete: if isAuthenticated() && 
                         (resource.data.uid == request.auth.uid || 
                          isAdmin());
      }
      
      // TYPING Subcollection
      match /typing/{typingId} {
        // Typing durumu okuma: Authenticated kullanıcılar
        allow read: if isAuthenticated();
        
        // Typing durumu yazma: Sadece kendi durumunu yazabilir
        allow create, update: if isAuthenticated() && 
                                 typingId == request.auth.uid &&
                                 request.resource.data.uid == request.auth.uid;
        
        // Typing durumu silme: Kendi durumunu silebilir
        allow delete: if isAuthenticated() && 
                         typingId == request.auth.uid;
      }
    }
  }
}

